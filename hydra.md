# Управление файлами конфигураций с помощью Hydra


## Начальные сведения

Hydra --- инструмент для создания и компоновки файлов конфигурации различных Python-приложений с акцентом на использование в ML-проектах.

Хорошей практикой при разработке любого более-менее сложного приложения считается выделение файлов с ключевыми параметрами, существенно влияющими на работу кода, в отдельные конфигурацинные файлы. Она облегчает восприятие структуры кода самим автором и другими разработчиками, упрощает тестирование приложения в различных сценариях его работы. Примерами таких параметров могут быть: номер сетевого порта, url-адреса, имя пользователя и его роль в БД и многое другое. ML-проекты в этом смысле ничуть не менее требовательны, ведь отдельные конфигурации могут потребоваться на многих этапах пайплайна:
на этапе получения и хранения данных, на этапе препроцессинга, при определении и обучении моделей. Более того, каждый из этих этапов может быть запущен большое число раз с различными параметрами в рамках экспериментов по построению оптимальной ML-модели.

Hydra дает возможность легко манипулировать различными набороми конфигураций:

1. выделять данные из исходных файлов в в .`yaml`-формате в отдельные группы и компоновать в общую иерархическую структуру,
2. переопределять группы конфигураций или отдельные параметры из командной строки или средствами python,
3. автоматически логировать использованные при очередном запуске параметры,
4. автоматически запускать множество задач с различными наборами параметров
5. и прочее

## Базовая структура

Для начала нужно создать папку, содержащую файлы конфигураций. Название и локация этой папки внутри проекта могут быть произвольными, в нашем случае это будет
`src/conf`. Внутри неё каждая подпапка будет соответствовать отдельному направлению, или группе конфигураций, связанных с тем или иным аспектом проекта. Например, добавим папки `data`, `model`, `preprocessing`, `secrets`  и `training` для групп параметров, связанных с источниками данных, определением модели, предобработкой данных, параметрами авторизации обучением модели соответственно.
Внутри каждой группы (папки) можно поместить произвольное число `.yaml`-файлов, соответствующих различным вариантам настроек. Добавим набор параметров для простой предобработки текстовых данных (`preprocessing/rubert_minimal.yaml`), параметры для ицициализации модели RuBert-tiny (`model/rubert.yaml`), а также параметры обучения модели (`rubert/training.yaml`), так что итоговое дерево файлов будет выглядеть следующим образом:

```
├── conf
    ├── config.yaml
    └── data
        ├── lakefs.yaml
    └── model
        ├── rubert.yaml
    └── preprocessing.yaml
        ├── rubert_minimal.yaml
    └── secrets
    └── training
        ├── rubert.yaml
```

Также в `src/conf` необходимо создать "главный" верхнеуровненвый конфиг `conf/config.yaml`, в котором необходимо указать стандартные группы конфигураций, которые будут использованы при запуске кода по умолчанию. Укажем группы препроцессинга, обучения, модели и параметры авторизации:

```
# conf/config.yaml
defaults:
  - preprocessing: rubert_minimal
  - training: rubert
  - model: rubert
  - secrets: hf
  - _self_
```

В главном конфиге можно указывать не только дефолтные группы, но и отдельные параметры ровно так же, как и в дочерних конфигах. В случае, когда имя параметра в главном конфиге совпадает с именем параметра в дочернем, результирующее значение параметра определяется по местонахождению поля `_self_`:

- если оно указано в конце списка `defaults`, то будет использовано значение из `src/conf`
- если оно указано в начале списка `defaults`, то будет использовано значение из `src/conf/*/*.yaml`

В нашем примере параметр `max_length` определен как в главном конфиге (256), так и в `conf/preprocessing/rubert_minimal.yaml` (512), а поскольку `_self_` указано в конце списка дефолтных параметров, будет использовано значение 256.


## Интеграция Hydra в Python-код, способы запуска

### hydra_main(), запуск .py-модулей из терминала

Интеграция Hydra в python-модуль осуществляется при помощи декоратора `hydra_main()`, который принимает в качестве параметров путь до папки с конфигурациями (относительно вызываемого модуля) и название главного файла конфигурации без указания расширения `-.yaml` (то есть, в нашем случае, `config`):

```
@hydra.main(version_base=None, config_path="src/conf", config_name="config")
def main(cfg: DictConfig):
    param = cfg["group_name"]["param"]
    # some logic with param...
    ...
```

Декоратор скомпонует параметры дефолтных групп главного конфига и свои собственные, считает их, и вернет в виде объекта `DictConfig` билиотеки `OmegaConf`.

При запуске модуля из терминала мы можем переопределять значения отдельных параметров или целых групп.

Увеличение числа эпох во время обучения:
```
python rubert_tiny_hydra_examply.py training.num_train_epochs=10
```

Пример замены группы параметров (при условии, что определен `conf/model/some_other_model.yaml`):
```
python rubert_tiny_hydra_examply.py model=some_other_model
```

Существующие в конфиге параметры можно удалять (learning rate будет сброшен на стандартное значение)
```
python rubert_tiny_hydra_examply.py training.learning_rate
```

Добавление нового параметра, не присутствующего ранее:
```
python rubert_tiny_hydra_examply.py +training.use_cpu=True
```

Также в таком варианте использования Hydra доступна возможность multirun запусков - выполнения кода со всеми перечисленными значениями параметров:

```
python rubert_tiny_hydra_example.py preprocessing.max_length=128,512
```

По умолчанию запуски проходят локально и последовательно, однако существует возможность интеграции с Ray для запуска на удаленных кластерах и с Joblib для распаллеливания задач по процессам [(документация, Ray)](https://hydra.cc/docs/plugins/ray_launcher/), [документация, Joblib](https://hydra.cc/docs/plugins/joblib_launcher/).

### Compose-API, использование в jupyter-notebooks

В ряде случаев, когда использование декоратора невозможно или неудобно (jupyter-ноутбуки, юнит-тесты, при отсутствии доступа к командной строке и др.), можно воспользоваться комбинацией методов `compose()` и `initialize()`[(документация)](https://hydra.cc/docs/advanced/compose_api/). Последний отвечает за инициализацию Hydra и путей файлов конфигураций, первый собирает указанный конфиг, изменяя/удаляя/добавляя параметры, передаваемые в списке `overrides`. Пример их совместного использования приведен в `src/config.py/compose_config()`. Соответственно, в нашем проекте использовать Compose API можно примерно таким способом:

```
from src.config import compose_config

main_conf = compose_config()

prepr_conf = main_conf["preprocessing"]
train_conf = main_conf["training"]
model_conf = main_conf["model"]
```

Пример изменения группы параметров:
```
from src.config import compose_config

main_conf = compose_config(overrides=["model='some_other_model'"])
model_conf = main_conf["model"]
```

 Данный способ не позволяет использовать multirun-запуски, настраивать логирование, менять стандартные пути для побочных артефактов работы Hydra и некоторые другие возможности.


 ## Некоторые полезные расширения синтаксиса для yaml-файлов

### Variable interpolation
В любом конфиг-файле мместо прямого указания значений параметров можно сослаться на значение другого параметра из этого же или другого конфига. Такая возможность предоставляется механизмом [интерполяции переменных (variable interpolation)](https://omegaconf.readthedocs.io/en/2.3_branch/usage.html#variable-interpolation) библиотеки OmegaConf. Им можно воспользоваться при помощи синтаксиса `${config_name.param_name}` (вариант с абсолютным путем), или `${.param_name}` (вариан с относительным путем). Пример использования этого механизма приведен в конфиге модели `conf/model/rubert.yaml`.

### Resolvers
`OmegaConf`` способен интерполировать не только ссылки на отдельные поля конфига, но и использовать user-defined способы интерполяции благодаря механизму [resolver'ов](https://omegaconf.readthedocs.io/en/2.3_branch/usage.html#resolvers). По умолчанию в OmegaConf добавлены несколько встроенных resolver'ов. Наиболее часто употребимым из них является `oc.env`, позволяющий обращаться к переменным окружения. Например, к имени пользователя можно обратиться следующим образом:

```
# some_config.yaml
name: ${oc.env:USER}
```

### Инициализация объектов
При создании файла конфигурации можно воспользоваться полем `_target_`, указав его значением экземпляр класса или вызываемый объект (callable). При этом остальные поля, указанные на том же уровне, будут использованы как параметры при инициализации класса. Отдельно импортировать этот класс в самом python-модуле не нужно, достаточно воспользоваться методом `instantiate()`:
```
from hydra.utils import instantiate

model = instantiate(confifg['model'])
```
В некоторых случаях может понадобится также дополнительное поле `_convert_`, определяющее, как `instantiate` будет обращаться с параметрами класса, не указанными в конфиге, а передаваемыми в runtime: конвертировать их в `OmegaConf`-контейнер полностью (None), частично (partial), или же вообще не конвертировать (object).


## Логирование

Окончание каждого запуска кода, содержащего `hydra_main()` сопровождается сохранением некоторого набора логов. По умолчаню эти логи сохраняются в `./outputs` в случае обычного запуска и в `./multirun` в multirun режиме. Каждая подпапка с названием формата `YYYY-mm-dd/HH-MM-SS` соответствует каждому отдельному запуску. В них содержатся:

- `config.yaml` - скомпонованный конфиг, с которым прошел запуск
- `hydra.yaml` - некоторые внутренние настройки Hydra, с которыми прошел запуск
- `overrides.yaml` - список параметров и их значений, измененных при помощи командной строки или функции `compose`
- `<filename.log>` - данные, переданные через модуль `logging`.

Некоторые параметры логирования могут быть изменениы как с использованием CLI, так и через дополнение определенных нами конфиг-файлов, определив дополнительное поле `hydra`. Например, так можно поменять выходной путь логов:

```
python rubert_tiny_hydra_example.py hydra.run.dir=some_other_out_dir
```

То же самое через изменение `src/conf/config.yaml`:

```
# config.yaml
hydra:
  run:
    dir: ./some_other_out_dir/${now:%Y-%m-%d}/${now:%H-%M-%S}
```

А так - поменять уровень логирования:

```
python rubert_tiny_hydra_example.py hydra.verbose=True
```

Подробнее про кастомизацию логирования и других служебных параметров Hydra  можно почитать [здесь](https://hydra.cc/docs/configure_hydra/intro/), [здесь](https://hydra.cc/docs/0.11/tutorial/logging/#internaldocs-banner) и [тут](https://hydra.cc/docs/0.11/configure_hydra/logging/).
